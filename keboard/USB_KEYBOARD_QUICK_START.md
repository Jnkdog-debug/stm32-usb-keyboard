# USB é”®ç›˜å¿«é€ŸéªŒè¯æŒ‡å—

## ğŸš€ å¿«é€Ÿå¼€å§‹ (3æ­¥)

### æ­¥éª¤1: ç¼–è¯‘å’Œçƒ§å½•
```bash
# è¿›å…¥å·¥ç¨‹ç›®å½•
cd /home/xyz/STM32/STM32project/keboard

# ç¼–è¯‘
make clean
make

# çƒ§å½•åˆ°STM32
sudo st-flash write build/keboard.bin 0x8000000
```

### æ­¥éª¤2: ç¡¬ä»¶è¿æ¥
- **USB**: å°†STM32çš„USBå£è¿æ¥åˆ°PC
- **UART** (å¯é€‰): ç”¨USBè½¬UARTæ¨¡å—è¿æ¥PA2/PA3æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯
  - PA2 -> TX
  - PA3 -> RX
  - GND -> GND

### æ­¥éª¤3: éªŒè¯åŠŸèƒ½

#### æœ€ç®€å•çš„éªŒè¯ (åªéœ€USB):
1. æ‰“å¼€**è®°äº‹æœ¬**æˆ–ä»»ä½•æ–‡æœ¬ç¼–è¾‘å™¨
2. æŒ‰ä¸‹çŸ©é˜µé”®ç›˜ä¸Šçš„ä»»æ„æŒ‰é”®
3. æ£€æŸ¥æ˜¯å¦è¾“å‡ºå¯¹åº”çš„æ•°å­— (æŒ‰é”®0->1, æŒ‰é”®1->2, ç­‰ç­‰)

#### æŸ¥çœ‹UARTè°ƒè¯•ä¿¡æ¯:
```bash
# Linux
minicom -D /dev/ttyUSB0 -b 115200

# æˆ–ç”¨ screen
screen /dev/ttyUSB0 115200
```

åº”è¯¥çœ‹åˆ°:
```
===============================================
   USB Keyboard - STM32F407
   Matrix: 3x3 (9 keys)
   USB: HID Keyboard
   UART2: 115200 baud
===============================================
Waiting for USB connection...

[USB] Key 1 pressed
[USB] Key 1 released
...
```

---

## ğŸ“‹ è¯¦ç»†æµ‹è¯•æ¸…å•

### åŸºç¡€æµ‹è¯• âœ“
- [ ] USBè®¾å¤‡åœ¨è®¾å¤‡ç®¡ç†å™¨ä¸­å‡ºç°
- [ ] æŒ‰ä¸‹æŒ‰é”®0ï¼Œè¾“å‡º"1"
- [ ] æŒ‰ä¸‹æŒ‰é”®1ï¼Œè¾“å‡º"2"
- [ ] æŒ‰ä¸‹æŒ‰é”®2ï¼Œè¾“å‡º"3"
- [ ] æŒ‰ä¸‹æŒ‰é”®3ï¼Œè¾“å‡º"4"
- [ ] æŒ‰ä¸‹æŒ‰é”®4ï¼Œè¾“å‡º"5"
- [ ] æŒ‰ä¸‹æŒ‰é”®5ï¼Œè¾“å‡º"6"
- [ ] æŒ‰ä¸‹æŒ‰é”®6ï¼Œè¾“å‡º"7"
- [ ] æŒ‰ä¸‹æŒ‰é”®7ï¼Œè¾“å‡º"8"
- [ ] æŒ‰ä¸‹æŒ‰é”®8ï¼Œè¾“å‡º"9"

### é«˜çº§æµ‹è¯• âœ“
- [ ] åŒæ—¶æŒ‰ä¸‹å¤šä¸ªæŒ‰é”®ï¼Œèƒ½åŒæ—¶è¾“å‡º
- [ ] å¿«é€Ÿè¿ç»­æŒ‰é”®ï¼Œä¸é—æ¼
- [ ] é•¿æŒ‰ä¸€ä¸ªæŒ‰é”®2ç§’ï¼Œä¸é‡å¤è¾“å…¥
- [ ] é‡Šæ”¾æŒ‰é”®åï¼Œè¾“å…¥åœæ­¢

---

## ğŸ”§ é”®ç›˜çŸ©é˜µæ˜ å°„

```
ç¡¬ä»¶ä½ç½®         USBè¾“å‡º
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 0 | 1 | 2 â”‚  â”‚ 1 2 3 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3 | 4 | 5 â”‚  â”‚ 4 5 6 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 6 | 7 | 8 â”‚  â”‚ 7 8 9 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âŒ æ•…éšœæ’æŸ¥

### é—®é¢˜: USBæ— æ³•è¯†åˆ«

**Windows:**
- æ‰“å¼€è®¾å¤‡ç®¡ç†å™¨ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰"æœªçŸ¥è®¾å¤‡"
- å¦‚æœæœ‰ï¼Œéœ€è¦å®‰è£…é©±åŠ¨

**Linux:**
```bash
# æŸ¥çœ‹USBè®¾å¤‡
lsusb
# åº”è¯¥çœ‹åˆ°: STMicroelectronics STM32F4xx

# æŸ¥çœ‹æ—¥å¿—
dmesg | tail
```

**è§£å†³:**
- æ¢ä¸€æ¡USBçº¿
- æ¢ä¸€ä¸ªUSBç«¯å£
- æ£€æŸ¥PA11/PA12å¼•è„šè¿æ¥

### é—®é¢˜: éƒ¨åˆ†æŒ‰é”®æ— æ³•è¾“å…¥

1. æ£€æŸ¥çŸ©é˜µé”®ç›˜ç¡¬ä»¶è¿æ¥
2. æŸ¥çœ‹UARTè¾“å‡ºæ˜¯å¦æœ‰å¯¹åº”æŒ‰é”®æ¶ˆæ¯
3. ç”¨ä¸‡ç”¨è¡¨æµ‹é‡GPIOå¼•è„šç”µå‹

### é—®é¢˜: è¾“å…¥é‡å¤æˆ–é”™è¯¯

1. å¢åŠ æ¶ˆæŠ–æ—¶é—´ (`matrix_keyboard.h` ä¸­ä¿®æ”¹ `DEBOUNCE_TIME`)
2. æ£€æŸ¥æŒ‰é”®ç¡¬ä»¶è´¨é‡
3. æ£€æŸ¥PCBå¸ƒçº¿

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `Core/Inc/matrix_keyboard.h` | çŸ©é˜µé”®ç›˜é…ç½® (GPIOå¼•è„š) |
| `Core/Src/matrix_keyboard.c` | çŸ©é˜µé”®ç›˜æ‰«æé©±åŠ¨ |
| `Core/Inc/usb_keyboard.h` | USB HIDæ¥å£å®šä¹‰ |
| `Core/Src/usb_keyboard.c` | USB HIDå®ç° |
| `Core/Src/main.c` | ä¸»ç¨‹åºå’Œé›†æˆ |
| `USB_DEVICE/App/usb_device.c` | USBè®¾å¤‡åˆå§‹åŒ– |
| `USB_KEYBOARD_VERIFICATION.txt` | è¯¦ç»†éªŒè¯æŒ‡å— |
| `test_usb_keyboard.py` | è‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…· |

---

## ğŸ’¡ é«˜çº§ç”¨æ³•

### ä¿®æ”¹æŒ‰é”®æ˜ å°„

ç¼–è¾‘ `Core/Src/usb_keyboard.c` ä¸­çš„ `matrix_to_usb_hid` æ•°ç»„:

```c
static const uint8_t matrix_to_usb_hid[9] = {
    KEY_1,      /* Matrix key 0 -> USB 1 */
    KEY_2,      /* Matrix key 1 -> USB 2 */
    KEY_3,      /* Matrix key 2 -> USB 3 */
    KEY_A,      /* ä¾‹å¦‚: æ”¹ä¸ºå­—æ¯A */
    KEY_5,
    KEY_6,
    KEY_7,
    KEY_8,
    KEY_9,
};
```

ç„¶åé‡æ–°ç¼–è¯‘çƒ§å½•ã€‚

### æ·»åŠ ä¿®é¥°é”® (Shift, Ctrl, Alt)

åœ¨ `main.c` çš„ `Matrix_Key_Callback` ä¸­:

```c
void Matrix_Key_Callback(uint8_t key_code, uint8_t pressed)
{
    if (key_code == 0) {
        // æŒ‰é”®0ä½œä¸ºShift
        if (pressed) {
            USB_Keyboard_SetModifier(KBD_MOD_LSHIFT);
        } else {
            USB_Keyboard_ClearModifier();
        }
    }
    
    USB_Keyboard_HandleMatrixKey(key_code, pressed);
}
```

---

## âœ¨ ç‰¹ç‚¹

âœ“ å®Œå…¨USB HIDå…¼å®¹  
âœ“ æ”¯æŒæœ€å¤š6é”®åŒæ—¶æŒ‰ä¸‹  
âœ“ 20msé˜²æŠ–å¤„ç†  
âœ“ 10msæ‰«æå‘¨æœŸ  
âœ“ UARTè°ƒè¯•è¾“å‡º  
âœ“ æ˜“äºå®šåˆ¶æŒ‰é”®æ˜ å°„  

---

## ğŸ“ éœ€è¦å¸®åŠ©?

1. æŸ¥çœ‹ `USB_KEYBOARD_VERIFICATION.txt` è·å–è¯¦ç»†æŒ‡å—
2. æŸ¥çœ‹ `README.md` è·å–é¡¹ç›®ä¿¡æ¯
3. è¿è¡Œ `python3 test_usb_keyboard.py` è¿›è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•
4. æ£€æŸ¥UARTä¸²å£è¾“å‡ºè¿›è¡Œè°ƒè¯•

---

**ç¥ä½ ä½¿ç”¨æ„‰å¿«ï¼** ğŸ‰
